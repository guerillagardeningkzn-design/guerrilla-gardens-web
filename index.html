// Checkpoint 1 – Confirmed working pattern (Feb 21, 2026)

// 1. Reading from sheets (client-side, no CORS pain)
const SHEET_ID = "1syH1gj9L-HHC3dlGoO-RTUthIXsEeUYC_81jlAvHfsg";

async function fetchSheetData(tabName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tabName)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`gviz fetch: ${res.status}`);

    let text = await res.text();

    // Stripping – this exact sequence worked (5460 chars cleaned, parse succeeded)
    text = text
      .replace(/^\/\*O_o\*\//, '')
      .replace(/^google\.visualization\.Query\.setResponse\s*\(/i, '')
      .replace(/\)\s*;?\s*$/, '')
      .trim();

    if (text.startsWith('(') && text.endsWith(')')) {
      text = text.slice(1, -1).trim();
    }

    text = text.replace(/,\s*([}\]])/g, '$1');

    const parsed = JSON.parse(text);

    function decodeHtmlEntities(str) {
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }

    const cols = (parsed.table.cols || []).map(col => {
      const raw = col.label || col.id || `col${col.id || ''}`;
      return decodeHtmlEntities(raw.trim());
    });

    const rows = (parsed.table.rows || []).map(r => {
      const obj = {};
      (r.c || []).forEach((cell, i) => {
        if (i < cols.length) obj[cols[i]] = cell?.v ?? null;
      });
      return obj;
    });

    return { success: true, columns: cols, rows };

  } catch (err) {
    console.error("gviz read failed:", err);
    return { success: false, error: err.message };
  }
}

// 2. Writing / updating (server-side via Apps Script POST + no-cors)
const API_BASE = "https://script.google.com/macros/s/AKfycbzTLEZjy5G5Xs9Vs5hS9QzWHlfMJTF5yF0Q-wCLYmPW6un0UAVHCnzx0Icu5ZMfF5K/exec";

async function sendToSheet(payload) {
  try {
    await fetch(API_BASE, {
      method: "POST",
      mode: "no-cors",
      cache: "no-cache",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    console.log("Write request sent (assuming success)");
    return true;
  } catch (err) {
    console.error("Write failed:", err);
    return false;
  }
}
